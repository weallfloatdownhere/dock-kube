- name: Add ArgoCD helm repository.
  kubernetes.core.helm_repository:
    name: argo
    repo_url: "{{ argocd_helm_charts_url }}"

- name: "Deploy ArgoCD."
  kubernetes.core.helm:
    atomic: True
    name: argo
    wait: True
    chart_ref: argo/argo-cd
    release_namespace: "{{ cluster.addons.argocd.namespace | default(argocd_default_namespace) }}"
    create_namespace: True
    kubeconfig: "{{ workspace_directory }}/kube_config_cluster.yml"
    values:
      redis-ha:
        enabled: "{{ True if (cluster.nodes | default([]) | length >= 3) else False }}"

      controller:
        enableStatefulSet: true

      repoServer:
        serviceAccount:
          create: true

      dex:
        enabled: false

      server:
        extraArgs: "{{ ['--insecure'] if (cluster.addons.argocd.insecure | default(argocd_default_insecure_state)) else [] }}"

      configs:
        secret:
          createSecret: true
          argocdServerAdminPassword: "{{ encrypted_admin_password }}"

      ingress:
          enabled: "{{ cluster.addons.argocd.enable_ingress | default(argocd_default_ingress_enabled) }}"
          annotations: {}
          labels: {}
          ingressClassName: ""
          hosts: []
          paths:
            - /
          pathType: Prefix
          extraPaths: []
          https: "{{ False if (cluster.addons.argocd.insecure | default(argocd_default_insecure_state)) else True }}"
          tls: []
          
      
