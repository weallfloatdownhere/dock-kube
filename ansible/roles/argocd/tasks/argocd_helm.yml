- name: Check if a values files is provided for argocd.
  stat:
    path: "{{ workspace_directory }}/values.yaml"
  register: argocd_custom_values

- name: Set values to use in the deployment.
  set_fact:
    value_file: |-
      {% set out = "{{role_path}}/files/default-values.yml" %}
      {% if argocd_custom_values.stat.exists == True %}
      {% set out = "{{workspace_directory}}/values.yml" %}
      {% endif %}
      {{ out }}

- name: Add ArgoCD helm repository.
  kubernetes.core.helm_repository:
    name: argo
    repo_url: https://argoproj.github.io/argo-helm

- name: "Deploy ArgoCD {{ cluster.addons.argocd.version | default('4.5.12') }}"
  kubernetes.core.helm:
    name: argo
    chart_ref: argo/argo-cd
    release_namespace: "{{ cluster.addons.argocd.namespace | default('argocd') }}"
    create_namespace: True
    kubeconfig: "{{ workspace_directory }}/kube_config_cluster.yml"
    values_files: 
      - '{{ value_file | trim }}'
      
